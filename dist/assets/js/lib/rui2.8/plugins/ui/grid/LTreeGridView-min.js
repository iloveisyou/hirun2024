/*
 * @(#) LTreeGridView-min.js
 * 
 * DevOn RUI
 * Build Version : 2.8
 * 
 * Copyright ⓒ LG CNS, Inc. All rights reserved.
 *
 * DevOn RUI의 모든 저작물은 LG CNS 의 지적재산입니다.
 * LG CNS로 부터 허가 받지 않은 경우 사용, 열람, 복사, 수정, 재배포 할 수 없으며 외부로의 유출을 금지합니다.
 * 특히 소스 코드를 수정하는 경우 기술 지원의 대상이 되지 않을 수 있습니다.
 * 자세한 사항은 계약사항에 따릅니다. 기타 사항은 devon@lgcns.com 으로 문의 하십시오.
 *
 * Do Not Erase This Comment!!! (이 주석문을 지우지 말것)
 *
 * rui/license.txt를 반드시 읽어보고 사용하시기 바랍니다. License.txt파일은 절대로 삭제하시면 안됩니다. 
 *
 * 1. 사내 사용시 KAMS를 통해 요청하여 사용허가를 받으셔야 소프트웨어 라이센스 계약서에 동의하는 것으로 간주됩니다.
 * 2. DevOn RUI가 포함된 제품을 판매하실 경우에도 KAMS를 통해 요청하여 사용허가를 받으셔야 합니다.
 * 3. KAMS를 통해 사용허가를 받지 않은 경우 소프트웨어 라이센스 계약을 위반한 것으로 간주됩니다.
 * 4. 별도로 판매될 경우는 LGCNS의 소프트웨어 판매정책을 따릅니다.
 */
Rui.namespace("Rui.ui.grid"),Rui.ui.grid.LTreeGridView=function(t){t=t||{},t=Rui.applyIf(t,Rui.getConfig().getFirst("$.ext.treeGrid.defaultProperties")),this.showData=new Rui.util.LCollection,Rui.ui.grid.LTreeGridView.superclass.constructor.call(this,t)},Rui.extend(Rui.ui.grid.LTreeGridView,Rui.ui.grid.LBufferGridView,{otype:"Rui.ui.grid.LTreeGridView",treeColumnId:null,defaultOpenDepth:-1,showData:null,isVirtualView:!0,fields:null,isShowDataPaste:!1,setPanel:function(t){t.on("cellClick",this.onCellClick,this,!0,{system:!0}),Rui.ui.grid.LTreeGridView.superclass.setPanel.call(this,t)},onLoadDataSet:function(t){this.doLoadDataSet(this.defaultOpenDepth,t.add),Rui.ui.grid.LTreeGridView.superclass.onLoadDataSet.call(this,t)},doLoadDataSet:function(t,e,i){var r=this.dataSet,a=this.fields.depthId,s=r.getCount();!0!==e&&(this.showData=new Rui.util.LCollection);for(var d=0,o=[],n=null,h=0;h<s;h++){var u=r.getAt(h),g="normal";h+1<s&&(l=r.getAt(h+1),i&&i[u.id]?u.get(a)<l.get(a)&&i[l.id]?g="open":"close"==i[u.id]&&(g="close"):u.get(a)+1==l.get(a)&&(g=t+1>l.get(a)?"open":"close")),u.setAttribute("_expand",g);var l,w=!1;i&&i[u.id]?w=!0:void 0===u.get(a)||u.get(a)<1?(w=!0,d=0,o=[]):(u.get(a)>d&&0<h&&h-1<s&&"open"==r.getAt(h-1).getAttribute("_expand")&&(d=u.get(a)),d>=u.get(a)&&(w=!0)),u.setAttribute("_show",w),u.get(a)<o.length&&(o=o.slice(0,u.get(a))),"normal"!=g&&(n=u.id,o.push(u.id)),h+1<s?(l=r.getAt(h+1)).pId=o[l.get(a)-1]:n&&u.id!=n&&r.get(n).get(a)<u.get(a)&&(u.pId=o[u.get(a)-1],u.pId),w&&this.showData.add(u.id,u)}},updateDepthExpand:function(t){var e=this.dataSet,i=this.fields.depthId;if(!(t>e.getCount()-1))for(var r=e.getAt(t),a=r.get(i),s=r.pId,d=r;0<=a&&("close"==d.getAttribute("_expand")&&d.setAttribute("_expand","open"),d=e.get(s));)s=d.pId,a=d.get(i)},updateParentExpand:function(t){var e,i=this.dataSet,r=this.fields.depthId,a=i.getCount();a<2?(e=i.getAt(t-1))&&e.setAttribute("_expand","normal"):1<a&&(e=i.getAt(t-1))&&(t==i.getCount()||e.get(r)==i.getAt(t).get(r)||e.get(r)!=i.getAt(t).get(r)-1?e.setAttribute("_expand","normal"):e.get(r)==i.getAt(t).get(r)-1&&1==i.getAt(t).getAttribute("_show")&&e.setAttribute("_expand","open"))},doAddData:function(t){var e,i=this.dataSet,r=this.fields.depthId,a=i.getAt(t.row),s=this.getParentRow(t.row);0<=s&&(e=i.getAt(s),a.pId=e.id);var d,o,n=a.get(r);!Rui.isUndefined(n)&&0!=n||a.setAttribute("_show",!0),e&&("open"==e.getAttribute("_expand")&&a.setAttribute("_show",!0),"normal"===e.getAttribute("_expand")&&e.setAttribute("_expand","close")),a.getAttribute("_show")&&(this.showData.indexOfKey(a.id)<0&&(d=(d=0<t.row?this.getVisibleRow(t.row-1):-1)<0?this.getBeforeVisibleRow(t.row,1):d,this.showData.insert(d+1,a.id,a)),0===n||Rui.isUndefined(n)||this.updateParentExpand(t.row)),a.getAttribute("_expand")||(a.setAttribute("_expand","normal"),t.row+1<i.getCount()&&(o=i.getAt(t.row+1),a.get(r)<o.get(r)&&(o.pId=a.id,a.setAttribute("_expand","close")))),Rui.ui.grid.LTreeGridView.superclass.doAddData.call(this,t)},doCellUpdateData:function(t){var e,i,r,a,s,d,o=this.fields.depthId;if(t.colId==o&&(i=(e=this.dataSet).getAt(t.row),0<=(r=this.getParentRow(t.row))&&(a=e.getAt(r),i.pId=a.id),a?("close"!=a.getAttribute("_expand")&&"normal"!=a.getAttribute("_expand")||a.setAttribute("_expand","close"),!1!==a.getAttribute("_show")&&"close"!=a.getAttribute("_expand")||(this.showData.remove(i.id),i.setAttribute("_show",!1))):(s=i.get(o),(t.row<1||e.getAt(t.row-1).get(o)==i.get(o)&&e.getAt(t.row-1).getAttribute("_show")||e.getAt(t.row-1).get(o)==i.get(o)-1&&e.getAt(t.row-1).getAttribute("_show"))&&(i.setAttribute("_show",!0),this.updateParentExpand(t.row)),s<1&&i.setAttribute("_show",!0),1==i.getAttribute("_show")?this.showData.indexOfKey(i.id)<0&&(d=0<t.row?this.getVisibleRow(t.row-1):0,this.showData.insert(d+1,i.id,i)):this.showData.remove(i.id))),this.fields.depthId==t.colId)return t.system=!1,void this.redoRenderData({resetScroll:!0});Rui.ui.grid.LTreeGridView.superclass.doCellUpdateData.call(this,t)},doRemoveData:function(t){var e,i,r,a=this.dataSet,s=this.fields.depthId,d=t.record,o=a.getCount();0==t.remainRemoved&&1==d.getAttribute("_show")?(e=0<t.row?this.getRowRecord(this.getVisibleRow(t.row-1)):null,i=t.row<o?a.getAt(t.row):null,e&&1==e.getAttribute("_show")&&(e||i)&&(!i||e.get(s)>=i.get(s))&&e.setAttribute("_expand","normal"),this.showData.remove(d.id)):(r=this.showData.get(d.id))&&r.state==Rui.data.LRecord.STATE_INSERT&&this.showData.remove(d.id),Rui.ui.grid.LTreeGridView.superclass.doRemoveData.call(this,t)},doUndoData:function(t){var e,i,r=this.dataSet,a=this.fields.depthId,s=t.record,d=r.getCount();s.state==Rui.data.LRecord.STATE_INSERT&&1==s.getAttribute("_show")&&(e=0<t.row?this.getRowRecord(this.getVisibleRow(t.row-1)):null,i=t.row<d?r.getAt(t.row):null,e&&1==e.getAttribute("_show")&&(e||i)&&(!i||e.get(a)>=i.get(a))&&e.setAttribute("_expand","normal"),this.showData.remove(s.id)),Rui.ui.grid.LTreeGridView.superclass.doUndoData.call(this,t)},onChangeRenderData:function(t){var e,i={};this.doLoadDataSet(this.defaultOpenDepth,!1,i),!t.forceRow||-1<(e=this.dataSet.getRow())&&this.expand(e),delete i,Rui.ui.grid.LTreeGridView.superclass.onChangeRenderData.call(this,t)},onColumnsChanged:function(t){this.doLoadDataSet(this.defaultOpenDepth),Rui.ui.grid.LTreeGridView.superclass.onColumnsChanged.call(this,t)},onCellClick:function(t){if(Rui.get(t.event.target).hasClass("L-grid-tree-col-icon")){var e=this.findRow(t.event.target);return this.toggle(e),Rui.util.LEvent.stopEvent(t),!1}},expand:function(t){var e=this.dataSet,i=this.fields.depthId,r=e.getCount();if(!(t>e.getCount()-1)){for(var a=e.getAt(t),s=a.get(i),d=0,o=0,n=t;0<=n;n--){if((h=e.getAt(n)).getAttribute("_show")&&0==d&&(d=this.showData.indexOfKey(h.id)),0==h.get(i)){o=n;break}}a.setAttribute("_show",!0),"normal"!=a.getAttribute("_expand")&&a.setAttribute("_expand","open"),this.updateDepthExpand(t);for(n=o;n<=t;n++){(h=e.getAt(n)).get(i)<=s&&"close"==h.getAttribute("_expand")&&h.setAttribute("_show",!0),h.get(i)<=s&&h.pId&&("open"==e.get(h.pId).getAttribute("_expand")&&1==e.get(h.pId).getAttribute("_show")?h.setAttribute("_show",!0):h.setAttribute("_show",!1)),h.getAttribute("_show")&&this.showData.indexOfKey(h.id)<0&&this.showData.insert(++d,h.id,h)}for(var h,n=t+1;n<r;n++){if(0==(h=e.getAt(n)).get(i))break;h.pId&&("open"==e.get(h.pId).getAttribute("_expand")&&1==e.get(h.pId).getAttribute("_show")?h.setAttribute("_show",!0):h.setAttribute("_show",!1)),this.updateParentExpand(n),h.getAttribute("_show")&&this.showData.indexOfKey(h.id)<0&&this.showData.insert(++d,h.id,h)}return this.redoRenderData({resetScroll:!0}),this}},collapse:function(t){var e=this.dataSet,i=this.fields.depthId,r=e.getCount();if(!(t>e.getCount()-1)){var a=e.getAt(t),s=a.get(i);"open"==a.getAttribute("_expand")&&a.setAttribute("_expand","close");for(var d=t+1;d<r;d++){var o=e.getAt(d);if(s==o.get(i))break;s<o.get(i)&&o.setAttribute("_show",!1),0==o.getAttribute("_show")&&-1<this.showData.indexOfKey(o.id)&&this.showData.remove(o.id)}return this.redoRenderData({resetScroll:!0}),this}},isExpand:function(t){return"open"==this.dataSet.getAt(t).getAttribute("_expand")},toggle:function(t){return this.isExpand(t)?this.collapse(t):this.expand(t),this},expandDepth:function(t){return this.doLoadDataSet(t),this.redoRenderData({resetScroll:!0}),this},getRenderRowClassName:function(t,e,i){var r=Rui.ui.grid.LTreeGridView.superclass.getRenderRowClassName.call(this,t,e,i),a=[],s=this.fields.depthId,d=e.getAttribute("_expand")||"normal";return a.push("L-grid-row-depth-"+e.get(s)),a.push("L-grid-row-expand-"+d),r+" "+a.join(" ")},getAriaAttr:function(t,e){var i=e.getAttribute("_expand")||"normal";return"open"===i?'aria-expand="true"':"close"===i?'aria-collapse="true"':""},getRenderBeforeCell:function(t,e,i,r,a){if(i.id!=this.treeColumnId)return"";t.css+=" L-grid-tree-column";var s='<div class="L-grid-tree-col L-grid-tree-col-depth-'+e.get(this.fields.depthId)+'" style="">';return s+='<div class="L-grid-tree-col-space"></div><div class="L-grid-tree-col-icon L-grid-row-select-ignore"></div>',s+="</div>"},getRowDom:function(t,e){if(t<0||t>this.dataSet.getCount()-1)return null;var i=this.getRowRecord(this.getVisibleRow(t));if(!i)return null;for(var r=i.id,a=(e<1?this.getFirstLiEl():this.getLastLiEl()).dom.children[0].rows,s=0;s<a.length;s++)if(Rui.util.LDom.hasClass(a[s],"L-grid-row-"+r)){t=s;break}return null===t?t:this.getRows(e)[t]},getRenderBody:function(t,e){var i=this.columnModel,r=this.templates||{},a=this.showData.length,s="",d="";if(this.firstWidth=this.headerEl.dom.childNodes[0].childNodes[0].childNodes[0].childNodes[0].offsetWidth,this.lastWidth=this.headerEl.dom.childNodes[0].childNodes[0].childNodes[1].childNodes[0].offsetWidth,e||(this.renderRange=this.getRenderRange()),this.renderRange)if(!0===t)var o=this.showData.getAt(0),d=this.getRenderRow(0,o,a,!1);else for(var n=this.renderRange.start;n<this.renderRange.end+1;n++){var o=this.getRowRecord(n),h=this.dataSet.indexOfKey(o.id);-1<i.freezeIndex&&(s+=this.getRenderRow(h,o,a,!0)),d+=this.getRenderRow(h,o,a,!1)}var u="width:"+this.firstWidth+"px;",g="width:"+this.lastWidth+"px;";-1<i.freezeIndex&&(this.marginLeft=i.getFirstColumnsWidth(!0),g+="margin-left:"+this.marginLeft+"px");return r.body.apply({listyle:"",rows1:s,tstyle1:u,rows2:d,tstyle2:g})},doRender:function(t){Rui.ui.grid.LTreeGridView.superclass.doRender.call(this,t),this.el.addClass("L-tree-grid"),Rui.useAccessibility()&&this.el.setAttribute("role","treegrid")},getVisibleRow:function(t){var e=this.dataSet.getAt(t);return e?this.showData.indexOfKey(e.id):t},getBeforeVisibleRow:function(t,e){for(var i=-1,r=this.dataSet,a=0,s=t-1;-1<s;s--)if(1==r.getAt(s).getAttribute("_show")&&a++,e<=a){i=s;break}return-1<i?this.getVisibleRow(i):i},getDataSetRow:function(t){var e=this.getRowRecord(t);return e?this.dataSet.indexOfKey(e.id):t},getRowRecord:function(t){return this.showData.getAt(t)},getDataCount:function(){return this.showData.length},getParentRow:function(t){var e=this.dataSet,i=this.fields.depthId,r=e.getAt(t).pId,a=e.getAt(t).get(i);if(a<1)return-1;for(var s=t-1;0<=s;s--)if(r){if(e.getAt(s).id==r)return s}else if(e.getAt(s).get(i)+1==a)return s;return-1},getPrevSiblingRow:function(t){for(var e=this.dataSet,i=this.fields.depthId,r=e.getNameValue(t,i),a=t-1;0<=a;a--)if(e.getNameValue(a,i)==r)return a;return-1},getNextSiblingRow:function(t){for(var e=this.dataSet,i=this.fields.depthId,r=this.dataSet.getCount(),a=e.getNameValue(t,i),s=t+1;s<r;s++){var d=e.getNameValue(s,i);if(d<a)break;if(d==a)return s}return-1},getChildRows:function(t){for(var e=this.dataSet,i=this.fields.depthId,r=this.dataSet.getCount(),a=e.getNameValue(t,i),s=[],d=t+1;d<r;d++){var o=e.getNameValue(d,i);if(o<a)break;if(o==a)break;o==a+1&&s.push(d)}return s},getAllChildRows:function(t){for(var e=this.dataSet,i=this.fields.depthId,r=this.dataSet.getCount(),a=e.getNameValue(t,i),s=[],d=t+1;d<r;d++){var o=e.getNameValue(d,i);if(o<a)break;if(o==a)break;s.push(d)}return s},filter:function(d,o){var n=this.dataSet;n.data=n.snapshot.clone(),n.mergeModifiedData(n.data);var h=new Rui.util.LCollection,u=0;n.data.each(function(t,e,i,r){var a,s;!0===d.call(o||this,t,e,i)&&(a=0,s=this,function t(e){var i;-1!=s.getParentRow(e)&&(a++,i=s.getParentRow(e),t.call(this,i)),h.has(n.getAt(e).id)||h.add(n.getAt(e).id,n.getAt(e))}(i),u=u<a?a:u)},this),this._isFiltered=!0,n.data=h,n.rowPosition=-1,this.expandDepth(u)},clearFilter:function(){var t=this.dataSet;t.getCount()<1&&t.modified.length<1&&t.snapshot.length<1||(t.data=t.snapshot.clone(),t.mergeModifiedData(t.data),delete t._isFiltered,t.rowPosition=-1,this.doLoadDataSet(this.defaultOpenDepth,!1),this.redoRenderData({resetScroll:!0}))}});